{% extends "base.html" %}
{% load staticfiles %}
{% load leaflet_tags %}

{% block head %}
    <title>Corruption map</title>
    {% leaflet_js %}  
    {% leaflet_css %}<!-- 
    <script src="http:///rawgithub.com/domoritz/leaflet-locatecontrol/gh-pages/dist/L.Control.Locate.min.js"</script>
    <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
    <link href="http:///rawgithub.com/domoritz/leaflet-locatecontrol/gh-pages/dist/L.Control.Locate.min.css" rel="stylesheet"> -->
    <script src='https://www.google.com/recaptcha/api.js'></script>
{% endblock %}

{% block map %}
{% load i18n %}

<h5>{% trans "To add claim please click on building on the map, or enter organization name in searchbox 'Organization', name of servant and describe what was wrong. After it press 'Send claim' button." %}</h5>

<div class="container-fluid">
    <div class="row">
        <div class="col-md-8">
            {% leaflet_map "main" callback="main_map_init" %}
        </div>
        <div class="col-md-4">
            <h3>{% trans "Add claim" %}</h3>

            <div class="right_block">
                <form role="form" id='claim_form'>
                    {% csrf_token %}
                    <div class="form-group">
                        <label for="organization_name">{% trans "Organization" %}:</label>
                        <input type="text" class="form-control" id="organization_name" placeholder='{% trans "Organization name" %}'>
                    </div>
                    <div class="form-group">
                        <label for="polygon_id">{% trans "Polygon ID" %}:</label>
                        <input type="text" class="form-control" id="polygon_id" name="polygon_id" readonly>
                    </div>
                    <div class="form-group">
                        <label for="servant">{% trans "Servant name" %}:</label>
                        <input type="text" class="form-control" id="servant" name="servant">
                    </div>
                    <div class="form-group">
                        <label for="claim_text">{% trans "Claim message" %}:</label>
                        <textarea type="text" class="form-control" id="claim_text" name="claim_text" required></textarea>
                    </div>

                    {% if user.is_authenticated %}
                        <div class="form-group">
                            <div class="checkbox">
                                <label>
                                    <input type="checkbox" name="anonymously"> {% trans "Keep me anonymously" %}
                                </label>
                            </div>
                        </div>
                    {% endif %}

                    {% if not user.is_authenticated %}
                        <div class="form-group">
                            <div class="g-recaptcha" data-sitekey="{{ recaptcha_public }}"></div>
                        </div>
                    {% endif %}

                    <div class="form-group">
                        <div id='message'></div>
                        <button type="submit" class="btn btn-primary">{% trans "Send claim" %}</button>
                    </div>
                </form>
            </div>

        </div>
    </div>
</div>


<script type="text/javascript">
    $(document).ready(function() {

        var csrftoken = $.cookie('csrftoken');
        function csrfSafeMethod(method) {
            // these HTTP methods do not require CSRF protection
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }
        $.ajaxSetup({
            beforeSend: function(xhr, settings) {
                if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            }
        });

        // $(".readonly").keydown(function(e){
        //     e.preventDefault();
        // });



        $("#claim_form").submit(function(event){          
            event.preventDefault();
            $.ajax({
                type: "POST",
                url: "{% url 'add_claim' %}",
                data: $('#claim_form').serialize(),
                success: function(data){
                    $('#message').html('{% trans "Thank you for your message." %}');
                    $('#claim_text').val('');
                    $('#servant').val('');                    
                }
            });
            grecaptcha.reset();
            return false;
        });

        $('#organization_name').autocomplete({
            lookup: {{places}},
            onSelect: function (suggestion) {
                $('#polygon_id').val(suggestion.data);
            }
        });
    });

    function select_building (polygon_id) {
        var places = {{places}};
        $('#polygon_id').val(polygon_id);
        for (var i = places.length - 1; i >= 0; i--) {
            if (places[i].data == polygon_id) {
                $('#organization_name').val(places[i].value);
                return
            }
        };
    }

</script>


{% endblock %}